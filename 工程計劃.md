# 萌典 CloudFlare Worker 工程計劃

## 專案概述

將 moedict-webkit 後端功能遷移到 CloudFlare Worker 環境，使用現代化技術棧重構：

- **CloudFlare Workers**: 無伺服器運行環境
- **R2 Storage + @cf-wasm/resvg**: 使用 R2 中的字體 SVG 檔案生成 PNG 圖片
- **React SSR**: 服務端渲染
- **R2 Storage**: 字典資料和字體 SVG 檔案儲存
- **7 個 API 端點**: `/a/`, `/t/`, `/h/`, `/c/`, `/raw/`, `/uni/`, `/pua/`

## 功能對應表

| 原功能 | CloudFlare Worker 實現 | 狀態 |
|--------|----------------------|------|
| `/:text.png` | `handleImageGeneration()` | ✅ 已完成 |
| `/:text.json` | `handleDictionaryAPI()` | ❌ 待實作 |
| `/:text` | `handlePageRequest()` | ❌ 待實作 |
| 靜態資源 | `handleStaticAssets()` | ✅ 基本完成 |
| 字體 SVG 圖片生成 | R2 SVG + resvg | ✅ 已完成 |
| 字典資料讀取 | R2 Storage | ❌ 待配置 |

## 實作優先順序

### 🚨 高優先級 (核心功能)

#### 1. 字典資料建置和上傳
**目標**: 建立完整的字典資料庫並上傳到 R2 Storage

**資料來源**:
- **原始資料**: https://github.com/g0v/moedict-data
- **造字轉換程式**: https://github.com/g0v/moedict-epub

**待辦事項**:
- [ ] **1.1** 設置本地開發環境
  - [ ] 克隆 moedict-data 和 moedict-epub 專案
  - [ ] 安裝必要依賴 (Perl, Python, lxml)
  - [ ] 設置建置環境

- [ ] **1.2** 建置字典資料檔案
  - [ ] 執行 `json2unicode.pl` 轉換造字碼為 Unicode
  - [ ] 生成 `dict-revised.unicode.json` 和 `dict-revised.pua.json`
  - [ ] 執行 `json2prefix.ls` 生成前綴索引
  - [ ] 執行 `autolink.ls` 生成自動連結
  - [ ] 執行 `link2pack.pl` 打包字典檔案

- [ ] **1.3** 驗證檔案結構
  - [ ] 檢查 `a/`, `t/`, `h/`, `c/` 目錄結構
  - [ ] 驗證 `@字.json` 和 `=詞.json` 格式
  - [ ] 檢查 `xref.json` 跨語言對照檔案
  - [ ] 驗證 `index.*.json` 索引檔案

- [ ] **1.4** 創建 R2 上傳說明
  - [ ] 使用rclone批量上傳

- [ ] **1.5** 上傳字典資料到 R2
  - [ ] 上傳華語字典 (`a/` 目錄)
  - [ ] 上傳台語字典 (`t/` 目錄)
  - [ ] 上傳客語字典 (`h/` 目錄)
  - [ ] 上傳兩岸字典 (`c/` 目錄)
  - [ ] 上傳索引和對照檔案

#### 2. 7 個 API 端點實作
**目標**: 實作完整的字典查詢 API 系統

**API 端點說明**:
- `/raw/`: 原始 JSON，Big5 區外字以造字碼 `{[abcd]}` 表示
- `/uni/`: Unicode 字元表示，造字碼轉為 Unicode
- `/pua/`: PUA 造字替代，使用 U+F9AD7 等編碼
- `/a/`: 華語辭典，含 PUA 造字和自動斷詞
- `/t/`: 台語辭典
- `/h/`: 客語辭典
- `/c/`: 兩岸詞典

**待辦事項**:
- [ ] **2.1** 實作 `/raw/` 端點
  - [ ] 直接返回原始 JSON 資料
  - [ ] 保持造字碼格式不變
  - [ ] 實現錯誤處理和快取

- [ ] **2.2** 實作 `/uni/` 端點
  - [ ] 將造字碼轉換為 Unicode 字元
  - [ ] 處理動態組字 (如 ⿰扌層)
  - [ ] 實現字元映射邏輯

- [ ] **2.3** 實作 `/pua/` 端點
  - [ ] 將造字碼轉換為 PUA 編碼
  - [ ] 使用 U+F9AD7 等替代編碼
  - [ ] 支援 MOEDICT 字型顯示

- [ ] **2.4** 實作 `/a/` 端點 (華語辭典)
  - [ ] 使用 PUA 造字替代
  - [ ] 實現內文自動斷詞
  - [ ] 支援多語言翻譯

- [ ] **2.5** 實作 `/t/` 端點 (台語辭典)
  - [ ] 處理台語發音和定義
  - [ ] 支援台語特殊字符

- [ ] **2.6** 實作 `/h/` 端點 (客語辭典)
  - [ ] 處理客語發音和定義
  - [ ] 支援客語特殊字符

- [ ] **2.7** 實作 `/c/` 端點 (兩岸詞典)
  - [ ] 處理簡繁對照
  - [ ] 支援兩岸用語差異

#### 3. 頁面渲染功能 (`/:text`)
**目標**: 實現完整的 HTML 頁面渲染

**待辦事項**:
- [ ] **3.1** 實現 HTML 模板渲染
  - [ ] 創建基本的 HTML 模板
  - [ ] 實現動態內容插入
  - [ ] 支援響應式設計

- [ ] **3.2** 實現字典查詢結果展示
  - [ ] 顯示詞條定義
  - [ ] 顯示發音資訊
  - [ ] 顯示例句和用法
  - [ ] 支援多語言切換

- [ ] **3.3** 實現搜尋結果頁面
  - [ ] 顯示相關詞條列表
  - [ ] 實現分頁功能
  - [ ] 支援模糊搜尋

- [ ] **3.4** 實現社交分享功能
  - [ ] Facebook 分享按鈕
  - [ ] Twitter 分享按鈕
  - [ ] 生成分享圖片

- [ ] **3.5** 實現響應式設計
  - [ ] 支援手機版顯示
  - [ ] 支援平板版顯示
  - [ ] 優化載入速度

### 🔧 中優先級 (配置和優化)

#### 4. 字體 SVG 檔案管理
**目標**: 管理 R2 Storage 中的字體 SVG 檔案

**待辦事項**:
- [ ] **4.1** 驗證字體 SVG 檔案完整性
  - [ ] 檢查所有字體的 SVG 檔案是否完整
  - [ ] 驗證 SVG 檔案格式和內容
  - [ ] 測試字體載入和渲染

- [ ] **4.2** 優化字體 SVG 檔案
  - [ ] 壓縮 SVG 檔案大小
  - [ ] 移除不必要的 metadata
  - [ ] 統一 SVG 格式和結構

- [ ] **4.3** 實現字體快取機制
  - [ ] 實現 Worker 內字體快取
  - [ ] 設置快取過期策略
  - [ ] 優化字體載入性能

#### 5. 靜態資源配置
**目標**: 設置和優化靜態資源

**待辦事項**:
- [ ] **5.1** 上傳靜態資源到 R2
  - [ ] 上傳 CSS 檔案
  - [ ] 上傳 JavaScript 檔案
  - [ ] 上傳圖片和圖標
  - [ ] 上傳 MOEDICT 字型檔案

- [ ] **5.2** 實現資源優化
  - [ ] 壓縮 CSS 和 JS
  - [ ] 優化圖片格式
  - [ ] 實現資源快取
  - [ ] 設置 CDN 快取策略

### 🔍 低優先級 (優化和增強)

#### 6. 性能優化
**目標**: 提升整體性能和用戶體驗

**待辦事項**:
- [ ] **6.1** 實現快取策略
  - [ ] 圖片生成結果快取
  - [ ] 靜態資源快取
  - [ ] 字典資料快取
  - [ ] API 回應快取

- [ ] **6.2** 實現 CDN 優化
  - [ ] 配置 CloudFlare CDN
  - [ ] 優化資源載入速度
  - [ ] 實現地理分佈

- [ ] **6.3** 實現監控和日誌
  - [ ] 設置性能監控
  - [ ] 實現錯誤追蹤
  - [ ] 設置告警機制

#### 7. 功能增強
**目標**: 添加新功能和改進現有功能

**待辦事項**:
- [ ] **7.1** 實現搜尋建議
  - [ ] 自動完成功能
  - [ ] 搜尋歷史
  - [ ] 熱門搜尋

- [ ] **7.2** 實現離線支援
  - [ ] Service Worker
  - [ ] 離線快取
  - [ ] 離線搜尋

- [ ] **7.3** 實現多語言支援
  - [ ] 國際化 (i18n)
  - [ ] 多語言介面
  - [ ] 語言切換

## 技術挑戰和解決方案

### 1. 字典資料建置和處理
**問題**: 需要從原始資料建置完整的字典資料庫
**解決方案**:
- 使用 moedict-data 和 moedict-epub 專案
- 執行 `json2unicode.pl` 轉換造字碼
- 使用 `json2prefix.ls` 和 `autolink.ls` 處理索引
- 使用 `link2pack.pl` 打包最終檔案
- 驗證檔案結構和內容完整性

### 2. 造字碼轉換邏輯
**問題**: 處理 Big5 區外字的造字碼轉換
**解決方案**:
- 實現 `{[abcd]}` 造字碼到 Unicode 的映射
- 處理動態組字 (如 ⿰扌層)
- 實現 PUA 編碼替代 (U+F9AD7 等)
- 支援 MOEDICT 字型顯示

### 3. 7 個 API 端點實作
**問題**: 每個端點有不同的資料處理邏輯
**解決方案**:
- `/raw/`: 直接返回原始 JSON
- `/uni/`: 造字碼轉 Unicode
- `/pua/`: 造字碼轉 PUA 編碼
- `/a/`, `/t/`, `/h/`, `/c/`: 各語言辭典處理
- 實現統一的錯誤處理和快取機制

### 4. 字體 SVG 檔案管理
**問題**: 管理大量字體 SVG 檔案
**解決方案**:
- 使用 R2 Storage 儲存 SVG 檔案
- 實現字體快取機制
- 優化 SVG 檔案大小和格式
- 支援多種字體 (楷體、明體、黑體等)

### 5. 資料上傳和同步
**問題**: 大量字典資料需要上傳到 R2 Storage
**解決方案**:
- 創建自動化上傳腳本
- 實現進度追蹤和錯誤處理
- 支援斷點續傳功能
- 實現資料驗證和完整性檢查

## 測試計劃

### 1. 字典資料建置測試
- [ ] 測試 moedict-data 和 moedict-epub 建置流程
- [ ] 驗證造字碼轉換正確性
- [ ] 測試檔案結構完整性
- [ ] 驗證索引和對照檔案

### 2. API 端點測試
- [ ] 測試 `/raw/` 端點功能
- [ ] 測試 `/uni/` 端點造字碼轉換
- [ ] 測試 `/pua/` 端點 PUA 編碼
- [ ] 測試 `/a/`, `/t/`, `/h/`, `/c/` 各語言辭典
- [ ] 測試錯誤處理和快取機制

### 3. 圖片生成測試
- [ ] 測試中文字符生成
- [ ] 測試不同字體效果
- [ ] 測試長文字處理
- [ ] 測試特殊字符處理
- [ ] 測試字體 SVG 載入

### 4. 整合測試
- [ ] 測試完整的工作流程
- [ ] 測試不同語言支援
- [ ] 測試錯誤處理
- [ ] 測試性能表現

### 5. 用戶測試
- [ ] 測試用戶體驗
- [ ] 測試響應式設計
- [ ] 測試載入速度
- [ ] 測試功能完整性

## 部署計劃

### 1. 開發環境
- [ ] 設置本地開發環境
- [ ] 配置開發工具
- [ ] 實現熱重載
- [ ] 設置除錯工具

### 2. 測試環境
- [ ] 設置測試環境
- [ ] 配置測試資料
- [ ] 實現自動化測試
- [ ] 設置測試監控

### 3. 生產環境
- [ ] 設置生產環境
- [ ] 配置生產資料
- [ ] 實現監控和日誌
- [ ] 設置備份機制

## 里程碑

### 🎯 第一階段 (2-3 週) - 字典資料建置
- [ ] 設置本地開發環境
- [ ] 建置完整的字典資料檔案
- [ ] 驗證檔案結構和內容
- [ ] 上傳字典資料到 R2 Storage

### 🎯 第二階段 (2-3 週) - API 端點實作
- [ ] 實作 7 個 API 端點
- [ ] 實現造字碼轉換邏輯
- [ ] 測試各端點功能
- [ ] 實現錯誤處理和快取

### 🎯 第三階段 (1-2 週) - 頁面渲染和優化
- [ ] 實現 HTML 頁面渲染
- [ ] 實現搜尋和分享功能
- [ ] 性能優化和測試
- [ ] 生產環境部署

## 風險評估

### 高風險
- **字典資料建置問題**: 可能影響整個系統功能
- **造字碼轉換邏輯**: 可能影響字元顯示正確性
- **R2 Storage 上傳**: 可能影響資料完整性

### 中風險
- **API 端點實作**: 可能影響查詢功能
- **字體 SVG 載入**: 可能影響圖片生成品質
- **性能問題**: 可能影響用戶體驗

### 低風險
- **頁面渲染**: 可能影響用戶體驗
- **功能增強**: 可能影響開發進度

## 總結

這個工程計劃涵蓋了將 moedict-webkit 後端遷移到 CloudFlare Worker 的所有必要步驟。重點是：

1. **字典資料建置**: 使用 moedict-data 和 moedict-epub 建置完整的字典資料庫
2. **7 個 API 端點實作**: 實現 `/raw/`, `/uni/`, `/pua/`, `/a/`, `/t/`, `/h/`, `/c/` 端點
3. **造字碼轉換**: 處理 Big5 區外字的造字碼轉換邏輯
4. **圖片生成**: 使用 R2 中的字體 SVG 檔案生成 PNG 圖片
5. **頁面渲染**: 實現完整的 HTML 頁面渲染

建議按照優先順序逐步實施，先完成字典資料建置，再實作 API 端點，最後進行頁面渲染和優化。
