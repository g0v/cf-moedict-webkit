# 萌典 CloudFlare Worker 工程計劃

## 專案概述

將 moedict-webkit 後端功能遷移到 CloudFlare Worker 環境，使用現代化技術棧重構：

- **CloudFlare Workers**: 無伺服器運行環境
- **Satori + @cf-wasm/resvg**: 替代 Node.js Canvas 的圖片生成方案
- **React SSR**: 服務端渲染
- **KV Storage**: 字典資料儲存
- **R2 Storage**: 字體和靜態資源

## 功能對應表

| 原功能 | CloudFlare Worker 實現 | 狀態 |
|--------|----------------------|------|
| `/:text.json` | `handleDictionaryAPI()` | ✅ 基本完成 |
| `/:text.png` | `handleImageGeneration()` | 🔄 需要修復 |
| `/:text` | `handlePageRequest()` | 🔄 需要修復 |
| 靜態資源 | `handleStaticAssets()` | ✅ 基本完成 |
| Canvas 圖片生成 | Satori + resvg | ❌ 待實現 |
| 檔案系統讀取 | KV Storage + R2 Storage | 🔄 需要配置 |

## 修復優先順序

### 🚨 高優先級 (核心功能)

#### 1. 圖片生成功能修復 (`/:text.png`)
**目標**: 實現完整的文字轉 PNG 圖片生成

**待辦事項**:
- [x] **1.1** 修復 URL 解碼問題
  - ✅ 確保 `decodeURIComponent` 正確處理中文字符
  - ✅ 處理 URL 編碼的特殊字符
  - ✅ 測試各種編碼格式的輸入

- [x] **1.2** 實現文字處理機制
  - ✅ 正確解析和清理輸入文字
  - ✅ 處理 mojibake (亂碼) 問題
  - ✅ 支援多語言字符處理

- [ ] **1.3** 實現字體載入機制 (新方案：內嵌字型)
  - [ ] 從 R2 Storage 載入 CJK 字體檔案 (如 NotoSerifCJKsc-Regular.otf)
  - [ ] 將字體轉換為 ArrayBuffer 格式
  - [ ] 傳遞給 @cf-wasm/resvg 的 font.fontBuffers
  - [ ] 支援多種字體 (kai, ming, song, hei)
  - [ ] 實現字體快取機制

- [x] **1.4** 實現文字佈局算法
  - ✅ 移植 `text2dim` 函數 (計算文字尺寸)
  - ✅ 實現 `drawBackground` 函數 (繪製背景格線)
  - ✅ 支援多行文字排列

- [ ] **1.5** 實現 SVG 到 PNG 轉換 (新方案：<text> + 內嵌字型)
  - [ ] 使用 `<text>` 元素替代 `<foreignObject>`
  - [ ] 內嵌 CJK 字型到 Resvg 的 fontBuffers
  - [ ] 使用 `@cf-wasm/resvg` 將 SVG 轉換為 PNG
  - [ ] 處理不同解析度和品質設定
  - [ ] 實現圖片快取機制

- [ ] **1.6** 測試圖片生成功能
  - [ ] 測試中文字符生成
  - [ ] 測試不同字體效果
  - [ ] 測試長文字處理
  - [ ] 測試特殊字符處理

**新技術方案**:
- **路線 A**: 使用 `<text>` + 內嵌字型
  - 從 R2 Storage 載入 CJK 字體檔案
  - 轉換為 ArrayBuffer 並傳遞給 Resvg
  - 避免 `<foreignObject>` 的相容性問題
  - 支援完整的 CJK 字符渲染

#### 2. 頁面渲染功能修復 (`/:text`)
**目標**: 實現完整的 HTML 頁面渲染

**待辦事項**:
- [ ] **2.1** 實現 HTML 模板渲染
  - 創建基本的 HTML 模板
  - 實現動態內容插入
  - 支援響應式設計

- [ ] **2.2** 實現字典查詢結果展示
  - 顯示詞條定義
  - 顯示發音資訊
  - 顯示例句和用法
  - 支援多語言切換

- [ ] **2.3** 實現搜尋結果頁面
  - 顯示相關詞條列表
  - 實現分頁功能
  - 支援模糊搜尋

- [ ] **2.4** 實現社交分享功能
  - Facebook 分享按鈕
  - Twitter 分享按鈕
  - 生成分享圖片

- [ ] **2.5** 實現響應式設計
  - 支援手機版顯示
  - 支援平板版顯示
  - 優化載入速度

### 🔧 中優先級 (資料和配置)

#### 3. 字典資料遷移
**目標**: 將所有字典資料遷移到 KV Storage

**待辦事項**:
- [ ] **3.1** 設置 KV Storage
  - 創建 DICTIONARY KV namespace
  - 配置預覽環境
  - 更新 wrangler.jsonc 配置

- [ ] **3.2** 創建自動化資料上傳程式
  - 創建 Node.js 批量上傳腳本 (`scripts/upload-dictionary.js`)
  - 實現進度追蹤和錯誤處理
  - 支援斷點續傳功能
  - 實現資料驗證和完整性檢查
  - 設置上傳日誌和統計

- [ ] **3.3** 使用自動化腳本遷移華語字典資料
  - 執行腳本上傳 `a/` 目錄下的所有 JSON 檔案
  - 測試資料完整性和載入
  - 驗證上傳結果

- [ ] **3.4** 使用自動化腳本遷移台語字典資料
  - 執行腳本上傳 `t/` 目錄下的所有 JSON 檔案
  - 測試資料完整性和載入
  - 驗證上傳結果

- [ ] **3.5** 使用自動化腳本遷移客語字典資料
  - 執行腳本上傳 `h/` 目錄下的所有 JSON 檔案
  - 測試資料完整性和載入
  - 驗證上傳結果

- [ ] **3.6** 使用自動化腳本遷移兩岸字典資料
  - 執行腳本上傳 `c/` 目錄下的所有 JSON 檔案
  - 測試資料完整性和載入
  - 驗證上傳結果

- [ ] **3.7** 實現資料同步機制
  - 實現增量更新
  - 設置資料備份
  - 實現版本控制

#### 4. 字體和靜態資源配置
**目標**: 設置 R2 Storage 並上傳所有資源

**待辦事項**:
- [ ] **4.1** 設置 R2 Storage
  - 創建 moedict-fonts bucket
  - 創建 moedict-assets bucket
  - 配置 CORS 設定

- [ ] **4.2** 創建自動化資源上傳程式
  - 創建 R2 批量上傳腳本 (`scripts/upload-resources.js`)
  - 實現字體檔案自動上傳
  - 實現靜態資源自動上傳
  - 支援檔案壓縮和優化
  - 實現上傳進度追蹤

- [ ] **4.3** 使用自動化腳本上傳字體檔案
  - 執行腳本自動上傳所有 WOFF2 字體檔案
  - 測試字體載入
  - 實現字體快取

- [ ] **4.4** 使用自動化腳本上傳靜態資源
  - 執行腳本自動上傳 CSS 檔案
  - 執行腳本自動上傳 JavaScript 檔案
  - 執行腳本自動上傳圖片和圖標

- [ ] **4.5** 實現資源優化
  - 壓縮 CSS 和 JS
  - 優化圖片格式
  - 實現資源快取

### 🔍 低優先級 (優化和增強)

#### 5. 性能優化
**目標**: 提升整體性能和用戶體驗

**待辦事項**:
- [ ] **5.1** 實現快取策略
  - 圖片生成結果快取
  - 靜態資源快取
  - 字典資料快取

- [ ] **5.2** 實現 CDN 優化
  - 配置 CloudFlare CDN
  - 優化資源載入速度
  - 實現地理分佈

- [ ] **5.3** 實現監控和日誌
  - 設置性能監控
  - 實現錯誤追蹤
  - 設置告警機制

#### 6. 功能增強
**目標**: 添加新功能和改進現有功能

**待辦事項**:
- [ ] **6.1** 實現搜尋建議
  - 自動完成功能
  - 搜尋歷史
  - 熱門搜尋

- [ ] **6.2** 實現離線支援
  - Service Worker
  - 離線快取
  - 離線搜尋

- [ ] **6.3** 實現多語言支援
  - 國際化 (i18n)
  - 多語言介面
  - 語言切換

## 技術挑戰和解決方案

### 1. URL 解碼和文字處理
**問題**: 正確處理 URL 編碼的中文字符和特殊字符
**解決方案**:
- 確保 `decodeURIComponent` 正確處理各種編碼格式
- 實現 mojibake (亂碼) 修復機制
- 測試各種輸入格式的相容性
- 實現多語言字符的正確處理

### 2. 字體載入和快取
**問題**: 在 Worker 環境中載入字體檔案
**解決方案**:
- 使用 R2 Storage 儲存字體檔案
- 實現字體快取機制
- 考慮字體子集化
- 使用 WOFF2 格式

### 3. 字典資料遷移
**問題**: 大量 JSON 檔案需要遷移到 KV Storage
**解決方案**:
- 創建 Node.js 自動化批量上傳腳本
- 實現進度追蹤和錯誤處理
- 支援斷點續傳功能
- 實現資料驗證機制
- 設置增量更新
- 實現資料備份

### 4. 資源檔案上傳
**問題**: 大量字體和靜態資源需要上傳到 R2 Storage
**解決方案**:
- 創建 R2 自動化上傳腳本
- 實現檔案壓縮和優化
- 支援批量上傳和進度追蹤
- 實現檔案完整性檢查

## 測試計劃

### 1. 單元測試
- [ ] 測試 URL 解析功能
- [ ] 測試字典查詢功能
- [ ] 測試圖片生成功能
- [ ] 測試頁面渲染功能

### 2. 整合測試
- [ ] 測試完整的工作流程
- [ ] 測試不同語言支援
- [ ] 測試錯誤處理
- [ ] 測試性能表現

### 3. 用戶測試
- [ ] 測試用戶體驗
- [ ] 測試響應式設計
- [ ] 測試載入速度
- [ ] 測試功能完整性

## 部署計劃

### 1. 開發環境
- [ ] 設置本地開發環境
- [ ] 配置開發工具
- [ ] 實現熱重載
- [ ] 設置除錯工具

### 2. 測試環境
- [ ] 設置測試環境
- [ ] 配置測試資料
- [ ] 實現自動化測試
- [ ] 設置測試監控

### 3. 生產環境
- [ ] 設置生產環境
- [ ] 配置生產資料
- [ ] 實現監控和日誌
- [ ] 設置備份機制

## 里程碑

### 🎯 第一階段 (1-2 週)
- [ ] 修復圖片生成功能
- [ ] 修復頁面渲染功能
- [ ] 基本功能測試通過

### 🎯 第二階段 (2-3 週)
- [ ] 完成字典資料遷移
- [ ] 完成字體和靜態資源配置
- [ ] 性能優化

### 🎯 第三階段 (1-2 週)
- [ ] 功能增強
- [ ] 用戶測試
- [ ] 生產環境部署

## 風險評估

### 高風險
- **Satori 相容性問題**: 可能影響圖片生成功能
- **字體載入問題**: 可能影響圖片品質
- **資料遷移問題**: 可能影響功能完整性

### 中風險
- **性能問題**: 可能影響用戶體驗
- **快取問題**: 可能影響載入速度
- **錯誤處理**: 可能影響穩定性

### 低風險
- **UI 設計**: 可能影響用戶體驗
- **功能增強**: 可能影響開發進度

## 總結

這個工程計劃涵蓋了將 moedict-webkit 後端遷移到 CloudFlare Worker 的所有必要步驟。重點是解決技術相容性問題，特別是 Satori + React SSR 的 `process is not defined` 錯誤，以及完成資料遷移和資源配置。

建議按照優先順序逐步實施，先解決核心功能問題，再進行資料遷移和性能優化。
