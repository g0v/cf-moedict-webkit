# 萌典 WebKit Cloudflare Worker 網頁生成部份工程計畫

## 概述

本計畫採用漸進式開發策略，將複雜的網頁生成功能分解為多個階段，逐步實現與原專案相同的功能。

## 開發階段

### 階段 1: React 框架網頁生成 ✅ 基礎準備

**目標**: 確保基本的 React 框架網頁可以成功生成

**任務清單**:
- [x] 1.1 安裝必要的依賴
  - ✅ 安裝 `preact` 和 `preact-render-to-string` 用於 SSR
  - ✅ 確保 TypeScript 配置正確（添加 jsxImportSource: preact）
- [x] 1.2 創建基本的 Preact 組件結構
  - ✅ 創建 `src/preact-components.tsx`
  - ✅ 實現基本的 `DictionaryEntryComponent`
  - ✅ 實現基本的 `HeteronymComponent`
  - ✅ 實現 `SearchResultsComponent` 和 `DefaultPageComponent`
- [x] 1.3 更新頁面渲染邏輯
  - ✅ 修改 `src/page-rendering.ts`
  - ✅ 集成 Preact SSR 渲染
  - ✅ 生成基本的 HTML 結構
  - ✅ 使用 `lookupDictionaryEntry` 統一查詢邏輯
- [x] 1.4 測試基本功能
  - ✅ 導出 `lookupDictionaryEntry` 函數供頁面渲染使用
  - ✅ 統一字典查詢邏輯，避免直接訪問 R2
  - ✅ 代碼通過 linter 檢查

**驗收標準**:
- 訪問 `/休息` 返回包含基本結構的 HTML 頁面
- Preact 組件成功渲染為 HTML 字符串
- 沒有 TypeScript 編譯錯誤

---

### 階段 2: 靜態資源載入 ✅ 公開端點

**目標**: 確保所有 CSS、JS、字體等資源能從 R2 公開端點正確載入

**任務清單**:
- [x] 2.1 配置 R2 公開存取端點
  - 在 Cloudflare Dashboard 中為 `moedict-assets-preview` 設置公開存取
  - 記錄公開端點 URL (例如: `https://pub-1808868ac1e14b13abe9e2800cace884.r2.dev`)
  - 測試端點可訪問性
- [x] 2.2 上傳靜態資源到 R2
  - ✅ 從原專案複製所有 CSS 文件到 `assets/css/`
  - ✅ 從原專案複製所有 JS 文件到 `assets/js/`
  - ✅ 從原專案複製所有字體文件到 `assets/fonts/`
  - ✅ 從原專案複製所有圖片文件到 `assets/images/`
  - 使用 rclone 或 Cloudflare Dashboard 上傳到 R2
- [x] 2.3 更新 HTML 模板中的資源引用
  - ✅ 修改 `src/page-rendering.ts` 中的 CSS/JS 引用
  - ✅ 將相對路徑改為 R2 公開端點 URL (`https://pub-1808868ac1e14b13abe9e2800cace884.r2.dev`)
  - ✅ 引用原專案的 `styles.css` 和 `jquery-ui` CSS
  - ✅ 引用必要的 JS 文件 (`es5-shim.js`, `es5-sham.js`, `deps.js`)
  - ✅ 保留自訂樣式作為補充
- [x] 2.4 測試資源載入
  - ✅ 訪問生成的網頁，檢查瀏覽器 Network 面板
  - ✅ 確認所有 CSS、JS 文件返回 200 狀態
  - ✅ 字體文件直接從 R2 端點載入 (避免 Worker 處理大檔案)
  - ✅ 驗證字體文件正確載入和顯示

**驗收標準**:
- 所有靜態資源從 R2 公開端點成功載入
- 網頁樣式正確顯示
- 字體文件正確載入
- 沒有 404 或 CORS 錯誤

---

### 階段 3: 完整網頁結構 ✅ 原站復刻

**目標**: 實現與原專案完全相同的網頁結構和功能

**任務清單**:
- [ ] 3.1 研究原專案網頁結構
  - 分析 `moedict-webkit/index.html` 的完整結構
  - 研究 `moedict-webkit/view.ls` 的 React 組件
  - 理解原專案的 CSS 類名和樣式
- [ ] 3.2 實現完整的 HTML 結構
  - 添加導航欄 (navbar)
  - 添加查詢框 (query-box)
  - 添加用戶偏好設置區域
  - 添加分享按鈕
  - 添加字體選擇器
- [ ] 3.3 實現完整的 Preact 組件
  - 完整實現所有 React 組件 (Term, Heteronym, Definition, XRefs 等)
  - 實現組件間的數據流
  - 添加事件處理邏輯
- [ ] 3.4 添加前端 JavaScript 功能
  - 實現語言切換功能
  - 實現字體選擇功能
  - 實現搜尋建議功能
  - 實現字詞記錄簿功能
- [ ] 3.5 測試完整功能
  - 測試所有頁面路由
  - 測試用戶交互功能
  - 測試響應式設計
  - 與原專案進行視覺對比

**驗收標準**:
- 網頁結構與原專案完全一致
- 所有用戶交互功能正常
- 樣式和佈局與原專案相同
- 響應式設計正確

---

### 階段 4: 筆順資料研究 ✅ 資料分析

**目標**: 研究原專案的筆順資料存儲位置和格式

**任務清單**:
- [ ] 4.1 分析筆順資料存儲位置
  - 檢查 `moedict-webkit/bin/` 目錄中的二進制文件
  - 檢查 `moedict-webkit/json/` 目錄 (如果存在)
  - 分析 `moedict-webkit/main.ls` 中的筆順載入邏輯
  - 研究 `moedict-webkit/js/jquery.strokeWords.js` 的實現
- [ ] 4.2 理解筆順資料格式
  - 分析 XML 格式的筆順資料 (如 `utf8/` 目錄)
  - 分析 JSON 格式的筆順資料
  - 分析二進制格式的筆順資料
  - 理解筆順動畫的渲染邏輯
- [ ] 4.3 研究筆順 API 調用
  - 分析原專案如何獲取筆順資料
  - 理解筆順資料的 URL 結構
  - 研究筆順動畫的觸發機制
- [ ] 4.4 文檔化筆順系統
  - 記錄筆順資料的存儲結構
  - 記錄筆順資料的格式規範
  - 記錄筆順動畫的實現原理
  - 制定筆順資料遷移計畫

**驗收標準**:
- 完全理解原專案的筆順資料系統
- 清楚筆順資料的存儲位置和格式
- 有完整的筆順系統文檔
- 制定可行的遷移策略

---

### 階段 5: 筆順資料遷移 ✅ R2 上傳

**目標**: 將筆順資料複製並上傳到 R2 存儲

**任務清單**:
- [ ] 5.1 準備筆順資料
  - 從原專案複製所有筆順相關文件
  - 整理筆順資料的目錄結構
  - 驗證筆順資料的完整性
- [ ] 5.2 上傳筆順資料到 R2
  - 創建筆順資料上傳腳本
  - 上傳 XML 格式的筆順資料
  - 上傳 JSON 格式的筆順資料 (如果存在)
  - 上傳二進制格式的筆順資料
- [ ] 5.3 配置筆順資料的公開存取
  - 在 R2 中設置筆順資料的公開存取權限
  - 測試筆順資料的可訪問性
  - 驗證筆順資料的完整性
- [ ] 5.4 更新筆順資料的引用路徑
  - 修改前端代碼中的筆順資料 URL
  - 更新筆順 API 的端點配置
  - 測試筆順資料的載入

**驗收標準**:
- 所有筆順資料成功上傳到 R2
- 筆順資料可以通過公開端點訪問
- 筆順資料的完整性得到驗證
- 前端可以正確載入筆順資料

---

### 階段 6: 筆順動畫實現 ✅ 功能完成

**目標**: 實現完整的筆順動畫功能

**任務清單**:
- [ ] 6.1 實現筆順按鈕功能
  - 在 Preact 組件中添加筆順按鈕
  - 實現筆順按鈕的點擊事件
  - 添加筆順動畫的容器元素
- [ ] 6.2 集成筆順動畫庫
  - 確保 `jquery.strokeWords.js` 正確載入
  - 確保 `raphael.js` 或 Canvas 支持正確載入
  - 確保 `sax.js` 等依賴正確載入
- [ ] 6.3 實現筆順資料獲取
  - 實現從 R2 獲取筆順資料的邏輯
  - 處理不同格式的筆順資料 (XML/JSON/二進制)
  - 實現筆順資料的緩存機制
- [ ] 6.4 實現筆順動畫渲染
  - 實現 SVG 或 Canvas 的筆順動畫
  - 實現筆順動畫的播放控制
  - 實現筆順動畫的樣式設置
- [ ] 6.5 測試筆順功能
  - 測試單字的筆順動畫
  - 測試多字的筆順動畫
  - 測試不同字體的筆順動畫
  - 測試筆順動畫的性能

**驗收標準**:
- 筆順按鈕可以正確觸發動畫
- 筆順動畫流暢播放
- 筆順動畫的視覺效果與原專案一致
- 筆順功能在各種情況下穩定運行

---

### 階段 7: 生產環境配置

**目標**: 配置生產環境並完成最終部署

**任務清單**:
- [ ] 7.1 同步資源到生產環境
  - 將 `moedict-assets-preview` 的內容同步到 `moedict-assets`
  - 將 `moedict-dictionary-preview` 的內容同步到 `moedict-dictionary`
  - 驗證生產環境資源的完整性
- [ ] 7.2 配置自定義域名
  - 以 custom domain 的方式部署 `moedict-assets` 的公開存取
  - 配置 CDN 和緩存策略
  - 測試自定義域名的可訪問性
- [ ] 7.3 更新依賴連結
  - 修改所有資源引用從 preview 端點改為生產端點
  - 更新 Worker 中的 R2 bucket 配置
  - 測試生產環境的完整功能
- [ ] 7.4 性能優化
  - 優化資源載入速度
  - 配置適當的緩存策略
  - 監控生產環境性能

**驗收標準**:
- 生產環境完全配置完成
- 所有資源通過自定義域名正確載入
- 生產環境性能達到預期
- 系統穩定運行


---

## 技術棧

### 後端 (Cloudflare Worker)
- **Runtime**: Cloudflare Workers (V8)
- **Language**: TypeScript
- **SSR**: Preact + preact-render-to-string
- **Storage**: Cloudflare R2
- **Routing**: 自定義路由系統

### 前端
- **Framework**: Preact (與 React 兼容)
- **Styling**: 原專案 CSS (從 R2 載入)
- **Animation**: Raphael.js / Canvas API
- **Dependencies**: jQuery, 原專案 JS 庫

### 存儲
- **字典資料**: R2 (moedict-dictionary-preview)
- **靜態資源**: R2 (moedict-assets-preview) + 公開端點
- **筆順資料**: R2 (moedict-assets-preview) + 公開端點

## 開發原則

1. **漸進式開發**: 每個階段都有明確的目標和驗收標準
2. **向後兼容**: 保持與原專案的功能和樣式一致
3. **性能優先**: 利用 R2 公開端點減少 Worker 負載
4. **可維護性**: 清晰的代碼結構和文檔
5. **測試驅動**: 每個階段都有完整的測試驗證

## 風險評估


### 低風險
- **基本網頁生成**: 技術成熟，風險較低
- **字典資料整合**: 已有 JSON 路由基礎

### 中風險
- **Preact SSR 兼容性**: 與原專案 React 的差異
- **R2 公開端點配置**: 需要正確的權限設置

### 高風險
- **筆順資料遷移**: 資料量大，格式複雜
- **字體文件載入**: 文件大，可能影響載入速度

## 時間估算

- **階段 1**: 2-6 (b) ✅ 已完成
- **階段 2**: 1-4 (b) ✅ 已完成
- **階段 3**: 2-6 (b) - 完整網頁結構
- **階段 4**: 3-10 (b) - 筆順資料研究
- **階段 5**: 1-4 (b) - 筆順資料遷移
- **階段 6**: 3-8 (b) - 筆順動畫實現
- **階段 7**: 2-6 (b) - 生產環境配置

**總計**: 14-44 (b)

## 成功標準

項目成功的標準是實現與原 `moedict-webkit` 完全相同的功能：

1. ✅ 完整的字典查詢功能
2. ✅ 多語言支持 (華語、台語、客語、兩岸)
3. ✅ 響應式網頁設計
4. ✅ 筆順動畫功能
5. ✅ 字體選擇功能
6. ✅ 用戶偏好設置
7. ✅ 社交分享功能
8. ✅ 字詞記錄簿功能

---

**計畫版本**: v1.1
**創建日期**: 2025-10-10
**最後更新**: 2025-10-10
