## 社群協作施工計畫（wrangler.jsonc.example 與 R2 Endpoint 變數化）

### 目標
- 將 assets 對應的 R2 公開端點抽成環境變數，集中於 `wrangler.jsonc`（例如：`ASSET_BASE_URL`）。
- 建立 `wrangler.jsonc.example`（保留完整結構，將敏感值與端點以註記/占位符呈現）。
- 將 `wrangler.jsonc` 納入 `.gitignore`，避免提交個人帳號設定。
- 更新 `README`：指引用戶 fork/clone 後，如何以自己的 Cloudflare 帳號建立 R2、安裝與設定 rclone、使用現有腳本上傳 dictionary/assets/fonts、建立/部署 worker。

---

### TODO 列表（按執行順序）

1) 變數化 assets 公開端點（R2 Endpoint）
- [ ] 在 `wrangler.jsonc` 的 `vars` 新增 `ASSET_BASE_URL`（例：`https://<pub-id>.r2.dev`）。
- [ ] 將程式中硬編碼的 R2 端點改為讀 `env.ASSET_BASE_URL`。
  - [ ] `src/page-rendering.ts` 內 `R2_ENDPOINT` 常數 → 改由 `env.ASSET_BASE_URL` 注入（建議：將 `generateHTMLWrapper`、`generateAboutHTMLWrapper` 接受 `env`，或建立可被注入的設定來源）。
  - [ ] `src/about-page.tsx` 內 `R2_ENDPOINT` 常數 → 改由 `env.ASSET_BASE_URL` 注入。
- [ ] 若未設定 `ASSET_BASE_URL`，則報錯提示，不要fallback

2) 建立 `wrangler.jsonc.example`
- [ ] 複製現有 `wrangler.jsonc` 結構，替換以下值為占位符與註記：
  - [ ] `r2_buckets[].bucket_name`、`preview_bucket_name` → 以 `"<your-bucket-name>"` 顯示。
  - [ ] `vars.ASSET_BASE_URL` → 以 `"https://<your-pub-id>.r2.dev"` 顯示，並於註記說明從 Cloudflare R2 公開端點取得。
- [ ] 在 `README` 指示：將 `wrangler.jsonc.example` 複製為 `wrangler.jsonc`，填上使用者自己的帳號設定。

3) 將 `wrangler.jsonc` 納入 `.gitignore`
- [ ] 若專案根目錄沒有 `.gitignore`，新增一個；若已有則加入一行：`wrangler.jsonc`。
- [ ] 在 `README` 註明此檔含個人帳號端點與 bucket 名稱，不應提交。

4) README 增補 Cloudflare 與 rclone 作業流程（以使用本 repo 的資料與腳本）
- [ ] 前置條件：Cloudflare 帳號、已安裝 Node.js、已安裝 `wrangler`、已安裝 `rclone`。
- [ ] Cloudflare 建置：
  - [ ] `wrangler auth login`
  - [ ] 建立 R2 buckets（production/preview）：`moedict-assets`, `moedict-assets-preview`, `moedict-dictionary`, `moedict-dictionary-preview`，字體 bucket 視需要建立。
- [ ] rclone 設定：
  - [ ] `rclone config` → 設定的部份較繁鎖，可以問chatGPT，主要是要填入 Access Key/Secret，endpoint 使用 `https://<account-id>.r2.cloudflarestorage.com`。
- [ ] 使用腳本上傳：
  - [ ] `./upload_dictionary.sh`（使用 `dictionary/pack|pcck|phck|ptck`），目標 bucket：`moedict-dictionary`。
  - [ ] `./upload_assets.sh`（使用 `assets/`），目標 bucket：`moedict-assets[-preview]`。
  - [ ] 字體（可選）：參考 `Upload_Fonts.md` 與 `large_fonts/` 工具，依里程碑提供的下載連結上傳。
- [ ] 設定 `wrangler.jsonc`：
  - [ ] 確認 `r2_buckets` 綁定：`ASSETS`、`DICTIONARY`、（可選）`FONTS`。
  - [ ] 設定 `vars.ASSET_BASE_URL` 為您開啟公開存取的 R2 端點（或 Pages/R2 透出的 CDN 端點）。
- [ ] 部署與驗證：
  - [ ] `npx wrangler dev --remote`、`npx wrangler deploy`。
  - [ ] 驗證 `/:text.json`、`/:text`、`/:text.png`、`/about.html` 與 CSS/JS/字體是否由 `ASSET_BASE_URL` 正確載入。

5) 程式碼改動的驗收要點
- [ ] 全域找出並移除硬編碼的 `r2.dev` 端點（以環境變數取代）。
- [ ] `src/page-rendering.ts` 與 `src/about-page.tsx` 的靜態資源連結均改以 `ASSET_BASE_URL` 組合。
- [ ] 伺服器渲染 HTML 的 `<link>` 與 `<script>`、`@font-face` 來源對應正確。
- [ ] 保持 `src/static-assets.ts` 以 `env.ASSETS` 讀取物件（作為必要時的 fallback 或直接服務）。
- [ ] `README` 能引導新貢獻者在自己的帳號上完成部署。

---

### 關聯檔案與程式碼
- `wrangler.jsonc`（現有配置）
- `wrangler.jsonc.example`（新檔，供社群複製編輯）
- `README.md`（需增補步驟）
- `R2_UPLOAD_GUIDE.md`（已有 rclone 與目錄規劃）
- `upload_dictionary.sh`、`upload_assets.sh`（上傳腳本）
- `src/types.ts` → 提供 `Env.ASSET_BASE_URL?` 類型欄位，可沿用
- `src/page-rendering.ts`、`src/about-page.tsx` → 存在硬編碼 R2 端點（需改為讀 `env.ASSET_BASE_URL`）

關鍵片段（硬編碼 R2 端點，需改為讀環境變數）

```126:149:src/page-rendering.ts
function generateAboutHTMLWrapper(bodyHTML: string): string {
	// R2 公開端點
	const R2_ENDPOINT = 'https://pub-1808868ac1e14b13abe9e2800cace884.r2.dev';

	return `<!DOCTYPE html>
...
</html>`;
}
```

```221:226:src/page-rendering.ts
	// R2 公開端點
	const R2_ENDPOINT = 'https://pub-1808868ac1e14b13abe9e2800cace884.r2.dev';

	return `<!DOCTYPE html>
```

```9:13:src/about-page.tsx
export function AboutPage() {
	// R2 公開端點
	const R2_ENDPOINT = 'https://pub-1808868ac1e14b13abe9e2800cace884.r2.dev';
```

支援的環境變數類型（可沿用）

```13:16:src/types.ts
  // 環境變數
  FONT_BASE_URL?: string;
  ASSET_BASE_URL?: string;
}
```

---

### 路由與資料流（重點驗證）
- API：`/:text.json`（含子路由 `/a|t|h|c|raw|uni|pua/`）
- 頁面：`/:text`、`/about.html`（需確保 CSS/JS/字體引用走 `ASSET_BASE_URL`）
- 圖片：`/:text.png`（字圖生成走 `env.FONTS`）

---

### 參考與附註
- R2 公開端點來源：Cloudflare R2 公開存取（或透過 Pages/R2 傳遞之 CDN 端點）。
- rclone endpoint 例：`https://<account-id>.r2.cloudflarestorage.com`。
- 字體上傳量大，參考 `Upload_Fonts.md` 與相關 milestone 貼文。 字圖相關milestone網址: https://github.com/g0v/cf-moedict-webkit/milestone/1?closed=1

